<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>body { margin: 0; background: #000; }</style>
</head>
<body>
    <script>
        const config = {
            type: Phaser.AUTO,
            width: 1000, height: 600,
            physics: { default: 'arcade' },
            scene: { preload, create, update }
        };

        const game = new Phaser.Game(config);
        let crew = [], rooms = [];

        function preload() {
            let g = this.make.graphics();
            // Космонавт
            g.fillStyle(0xffffff); g.fillCircle(10, 10, 10);
            g.generateTexture('pawn', 20, 20);
            // Отсек
            g.clear(); g.fillStyle(0x333333); g.fillRect(0,0,100,100);
            g.lineStyle(1, 0x666666); g.strokeRect(0,0,100,100);
            g.generateTexture('room', 100, 100);
        }

        function create() {
            const names = ["Реактор", "Кислород", "Склад", "Жилой", "Мостик"];
            for(let i=0; i<5; i++) {
                let r = {
                    x: 150 + i*110, y: 250,
                    o2: 100, name: names[i],
                    sprite: this.add.image(150 + i*110, 250, 'room').setInteractive()
                };
                r.text = this.add.text(r.x - 45, r.y - 45, '', {fontSize: '10px'});
                rooms.push(r);
            }

            // Создаем одну автономную пешку
            let p = this.physics.add.sprite(200, 200, 'pawn');
            p.job = null;
            crew.push(p);

            this.add.text(20, 20, "RIM-STATION: Пешка сама ищет отсек с низкой концентрацией O2", {fill: '#0f0'});
        }

        function update() {
            rooms.forEach(r => {
                r.o2 -= 0.05; // Воздух уходит
                if(r.o2 < 0) r.o2 = 0;
                r.text.setText(`${r.name}\nO2: ${Math.floor(r.o2)}%`);
                r.sprite.setTint(r.o2 < 30 ? 0xff0000 : 0xffffff);
            });

            crew.forEach(p => {
                // Если нет задачи, ищем отсек, где O2 < 50
                if (!p.job) {
                    let criticalRoom = rooms.find(r => r.o2 < 50);
                    if (criticalRoom) {
                        p.job = criticalRoom;
                        this.physics.moveToObject(p, criticalRoom, 100);
                    }
                }

                // Если пришел в отсек - "чинит"
                if (p.job) {
                    let dist = Phaser.Math.Distance.Between(p.x, p.y, p.job.x, p.job.y);
                    if (dist < 5) {
                        p.setVelocity(0);
                        p.job.o2 += 0.5; // Работает!
                        if (p.job.o2 >= 100) p.job = null; // Задача выполнена
                    }
                }
            });
        }
    </script>
</body>
</html>
